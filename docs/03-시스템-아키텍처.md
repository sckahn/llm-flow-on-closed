# LLMFlow 시스템 아키텍처

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | LLMFlow 시스템 아키텍처 |
| 버전 | 2.0 (오픈소스 조합 가이드 반영) |
| 작성일 | 2025-12-13 |
| 핵심 철학 | "Dify를 OS처럼, 부족한 장기(Organ)는 최고 성능의 전용 모듈로 이식한다." |

---

## 1. 아키텍처 개요

### 1.1 설계 원칙

| 원칙 | 설명 |
|------|------|
| **폐쇄망 호환** | 외부 인터넷 연결 없이 완전 운영 |
| **멀티테넌시** | 부서/프로젝트별 격리된 환경 |
| **수평 확장** | 컴포넌트별 독립적 스케일링 |
| **고가용성** | 단일 장애점 제거, 자동 복구 |
| **보안 우선** | Zero Trust, 최소 권한 원칙 |
| **운영 단순화** | 복잡한 오케스트레이션 제거 (Ray 미사용) |

### 1.2 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              사용자 레이어                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │
│   │ 인트라넷    │   │ 그룹웨어   │   │   ERP      │   │  API 클라이언트│    │
│   │   포털      │   │  플러그인   │   │   연동      │   │              │    │
│   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘    │
│          │                 │                 │                 │           │
└──────────┼─────────────────┼─────────────────┼─────────────────┼───────────┘
           │                 │                 │                 │
           └─────────────────┴────────┬────────┴─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         인증/게이트웨이 레이어                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        Apache APISIX                                │   │
│   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │   │
│   │   │ 라우팅  │  │  Rate   │  │  Auth   │  │  로깅   │  │  캐싱   │  │   │
│   │   │         │  │ Limiting│  │  (JWT)  │  │         │  │         │  │   │
│   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│              ┌────────────┴────────────┐                                    │
│              ▼                         ▼                                    │
│   ┌─────────────────┐       ┌─────────────────┐                             │
│   │    Keycloak     │       │       OPA       │                             │
│   │   (SSO/LDAP)    │       │  (정책 엔진)    │                             │
│   └─────────────────┘       └─────────────────┘                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         애플리케이션 레이어                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        Dify (메인 플랫폼)                            │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│   │   │ 워크플로우 │  │   RAG    │  │ 플레이   │  │ 프롬프트 │           │   │
│   │   │  빌더    │  │ 파이프라인│  │ 그라운드 │  │  관리    │           │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘           │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐                         │   │
│   │   │  API     │  │  플러그인 │  │  Worker  │                         │   │
│   │   │ 서비스   │  │ 마켓플레이스│ │ (비동기) │                         │   │
│   │   └──────────┘  └──────────┘  └──────────┘                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│              ┌────────────┼────────────┐                                    │
│              ▼            ▼            ▼                                    │
│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│   │   LangGraph     │ │    Presidio     │ │    Langfuse     │              │
│   │ (복잡 에이전트)  │ │  (PII 필터링)   │ │  (Observability)│              │
│   └─────────────────┘ └─────────────────┘ └─────────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         데이터 파이프라인 레이어 (ETL & RAG)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Unstructured (ETL/OCR)                          │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│   │   │ PDF 파싱 │  │ PPT 변환 │  │ 표 추출  │  │ OCR 처리 │           │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     LlamaIndex (고급 RAG)                            │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│   │   │ 고급청킹 │  │ GraphRAG │  │ 하이브리드│  │ 멀티모달 │           │   │
│   │   │          │  │ 파이프라인│  │ 검색     │  │ 인덱싱   │           │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           데이터 스토어 레이어                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │
│   │   Milvus    │   │   Neo4j     │   │ PostgreSQL  │   │    MinIO    │    │
│   │  (벡터 DB)  │   │ (Graph DB)  │   │ (메타데이터)│   │(파일 스토리지)│   │
│   └─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘    │
│                                                                             │
│   ┌─────────────┐   ┌─────────────┐                                        │
│   │    Redis    │   │ OpenSearch  │                                        │
│   │  (캐싱)     │   │ (감사 로그) │                                        │
│   └─────────────┘   └─────────────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           추론 레이어 (Inference)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    LLM 서빙 (vLLM - OpenAI 호환 API)                  │   │
│   │                                                                     │   │
│   │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │   │
│   │   │    vLLM     │ │    vLLM     │ │    vLLM     │ │    vLLM     │  │   │
│   │   │  Llama 70B  │ │ Mistral 7B  │ │  Qwen 72B   │ │   Custom    │  │   │
│   │   │  (4x GPU)   │ │  (1x GPU)   │ │  (4x GPU)   │ │   Model     │  │   │
│   │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │              Embedding & Reranking (TEI / Infinity)                 │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────┐   ┌─────────────────────────┐        │   │
│   │   │   TEI / Infinity        │   │   TEI / Infinity        │        │   │
│   │   │   (Embedding Server)    │   │   (Reranking Server)    │        │   │
│   │   │   - bge-m3              │   │   - bge-reranker-v2-m3  │        │   │
│   │   │   - e5-large            │   │   - cross-encoder       │        │   │
│   │   └─────────────────────────┘   └─────────────────────────┘        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         LLMOps 레이어                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐   ┌─────────────────────────┐   ┌─────────────┐          │
│   │   MLflow    │   │    LLaMA-Factory        │   │ Model       │          │
│   │ (실험 추적) │   │  (파인튜닝 WebUI)        │   │ Registry    │          │
│   │             │   │  - LoRA/QLoRA           │   │             │          │
│   │             │   │  - DeepSpeed 내장       │   │             │          │
│   └─────────────┘   └─────────────────────────┘   └─────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        인프라 레이어 (Kubernetes)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Kubernetes Cluster                               │   │
│   │                                                                     │   │
│   │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐            │   │
│   │   │  Namespace    │ │  Namespace    │ │  Namespace    │            │   │
│   │   │  dept-finance │ │  dept-hr      │ │  project-ai   │            │   │
│   │   └───────────────┘ └───────────────┘ └───────────────┘            │   │
│   │                                                                     │   │
│   │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐            │   │
│   │   │ NetworkPolicy │ │ ResourceQuota │ │    RBAC       │            │   │
│   │   └───────────────┘ └───────────────┘ └───────────────┘            │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │
│   │ NVIDIA GPU  │   │ Prometheus  │   │  Grafana    │   │   Vault     │    │
│   │  Operator   │   │ (메트릭)    │   │ (대시보드)  │   │  (시크릿)   │    │
│   └─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 레이어별 상세 설계

### 2.1 사용자 레이어

#### 접근 채널

| 채널 | 프로토콜 | 용도 |
|------|----------|------|
| 인트라넷 포털 | HTTPS | 웹 기반 UI 접근 |
| 그룹웨어 플러그인 | REST API | 그룹웨어 내 AI 기능 |
| ERP 연동 | REST/gRPC | 업무 시스템 통합 |
| API 클라이언트 | OpenAI 호환 API | 개발자 직접 호출 |

### 2.2 인증/게이트웨이 레이어

#### Apache APISIX 구성

```yaml
# apisix.yaml
apisix:
  node_listen: 9080
  enable_ipv6: false

plugins:
  - jwt-auth
  - key-auth
  - limit-req
  - limit-count
  - ai-rate-limiting  # AI 전용 토큰 제한
  - prometheus
  - request-validation
  - proxy-cache

etcd:
  host:
    - "http://etcd:2379"
```

#### Keycloak 연동

```yaml
# APISIX JWT 플러그인 설정
routes:
  - uri: /api/*
    plugins:
      jwt-auth:
        header: Authorization
        query: token
        cookie: jwt

      openid-connect:
        client_id: llmflow
        client_secret: ${KEYCLOAK_SECRET}
        discovery: https://keycloak/realms/llmflow/.well-known/openid-configuration
        bearer_only: true
        realm: llmflow
```

### 2.3 애플리케이션 레이어

#### Dify 컴포넌트 구조

```
┌─────────────────────────────────────────────────────────────┐
│                         Dify                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                      ┌─────────────┐      │
│  │   Web UI    │◄────────────────────►│   API       │      │
│  │  (Next.js)  │                      │  (Flask)    │      │
│  └─────────────┘                      └──────┬──────┘      │
│                                              │              │
│                    ┌─────────────────────────┼──────────┐  │
│                    │                         │          │  │
│                    ▼                         ▼          ▼  │
│            ┌─────────────┐           ┌─────────────┐       │
│            │   Worker    │           │   Sandbox   │       │
│            │  (Celery)   │           │  (코드 실행)│       │
│            └─────────────┘           └─────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Dify 서비스 연결

| 연결 대상 | 프로토콜 | 용도 |
|----------|----------|------|
| PostgreSQL | TCP 5432 | 메타데이터, 사용자, 앱 정보 |
| Redis | TCP 6379 | 세션, 캐시, Celery 브로커 |
| Milvus | gRPC 19530 | 벡터 저장/검색 |
| Neo4j | Bolt 7687 | GraphRAG 지식 그래프 |
| vLLM | HTTP 8000 | LLM 추론 |
| TEI/Infinity | HTTP 8080 | 임베딩, 리랭킹 |
| MinIO | HTTP 9000 | 파일 저장 |
| Langfuse | HTTP 3000 | 트레이싱 |

### 2.4 데이터 파이프라인 레이어

#### Unstructured ETL 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│                    Unstructured Pipeline                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [입력 문서]                                                │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│   │    PDF      │ │    PPT      │ │   Excel     │          │
│   │  (다단 레이아웃)│ │  (슬라이드) │ │   (표)      │          │
│   └──────┬──────┘ └──────┬──────┘ └──────┬──────┘          │
│          │               │               │                  │
│          └───────────────┼───────────────┘                  │
│                          ▼                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                  Unstructured API                   │  │
│   │   ┌─────────┐  ┌─────────┐  ┌─────────┐            │  │
│   │   │ Partition│  │  OCR    │  │  Table  │            │  │
│   │   │ (구조분석)│  │ (텍스트) │  │  (표추출)│            │  │
│   │   └─────────┘  └─────────┘  └─────────┘            │  │
│   └─────────────────────────────────────────────────────┘  │
│                          │                                  │
│                          ▼                                  │
│   [출력: 구조화된 청크 + 메타데이터]                          │
│   {                                                         │
│     "text": "추출된 텍스트",                                  │
│     "metadata": {                                           │
│       "page": 1,                                            │
│       "element_type": "table",                              │
│       "coordinates": {...}                                  │
│     }                                                       │
│   }                                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### LlamaIndex + GraphRAG 구조

```
┌─────────────────────────────────────────────────────────────┐
│                   LlamaIndex RAG Pipeline                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [1] 고급 청킹 전략                                         │
│   ┌───────────────────────────────────────────────────────┐│
│   │ Semantic Chunking │ Sentence Window │ Hierarchical   ││
│   └───────────────────────────────────────────────────────┘│
│                          │                                  │
│   [2] 인덱싱 (듀얼 저장)                                     │
│          ┌───────────────┴───────────────┐                  │
│          ▼                               ▼                  │
│   ┌─────────────┐                 ┌─────────────┐          │
│   │   Milvus    │                 │   Neo4j     │          │
│   │  (벡터 DB)  │                 │ (그래프 DB) │          │
│   │             │                 │             │          │
│   │ - 시맨틱 검색│                 │ - 엔티티    │          │
│   │ - 유사도 매칭│                 │ - 관계 그래프│          │
│   └─────────────┘                 └─────────────┘          │
│                                                             │
│   [3] 하이브리드 검색                                        │
│   ┌───────────────────────────────────────────────────────┐│
│   │  Query ──► Vector Search ──┬──► Fusion ──► Results   ││
│   │            Graph Traversal ─┘                         ││
│   └───────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 데이터 스토어 레이어

#### Milvus 클러스터 구조

```
┌─────────────────────────────────────────────────────────────┐
│                     Milvus Cluster                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐                                          │
│   │    Proxy    │ ◄── 클라이언트 요청 수신                   │
│   │  (Replicas) │                                          │
│   └──────┬──────┘                                          │
│          │                                                  │
│   ┌──────┴──────┐                                          │
│   │   Coord     │ ◄── 클러스터 조정                         │
│   │  Services   │                                          │
│   └──────┬──────┘                                          │
│          │                                                  │
│   ┌──────┴──────────────────────────────┐                  │
│   │                                      │                  │
│   ▼                                      ▼                  │
│ ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│ │ Data Node │  │Query Node │  │Index Node │               │
│ │ (저장)    │  │ (검색)    │  │ (인덱싱)  │               │
│ └───────────┘  └───────────┘  └───────────┘               │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                    Storage                          │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │  │
│   │  │  etcd   │  │  MinIO  │  │  Pulsar │             │  │
│   │  │ (메타)  │  │ (벡터)  │  │ (로그)  │             │  │
│   │  └─────────┘  └─────────┘  └─────────┘             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Neo4j GraphRAG 스키마

```cypher
// 노드 타입
(:Document {id, title, created_at, tenant_id})
(:Chunk {id, content, embedding_id, position})
(:Entity {name, type, description})  // 사람, 조직, 개념 등
(:Topic {name, description})

// 관계 타입
(:Document)-[:HAS_CHUNK]->(:Chunk)
(:Chunk)-[:MENTIONS]->(:Entity)
(:Entity)-[:RELATED_TO]->(:Entity)
(:Chunk)-[:ABOUT]->(:Topic)
(:Entity)-[:BELONGS_TO]->(:Topic)
```

#### 데이터 파티셔닝 전략

```
┌─────────────────────────────────────────────────────────────┐
│                    Milvus Collections                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Collection: documents                                     │
│   ├── Partition: dept_finance                               │
│   ├── Partition: dept_hr                                    │
│   ├── Partition: dept_it                                    │
│   └── Partition: shared                                     │
│                                                             │
│   Collection: chat_history                                  │
│   ├── Partition: user_group_a                               │
│   └── Partition: user_group_b                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Neo4j Multi-tenancy                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Database: tenant_finance                                  │
│   Database: tenant_hr                                       │
│   Database: tenant_shared                                   │
│                                                             │
│   또는 Label 기반:                                           │
│   (:Document:TenantFinance)                                 │
│   (:Document:TenantHR)                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.6 추론 레이어

#### vLLM 단독 서빙 구조 (Ray 미사용)

```
┌─────────────────────────────────────────────────────────────┐
│              vLLM 인스턴스 (OpenAI 호환 API)                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │              Kubernetes Service (LoadBalancer)       │  │
│   │                    llm-service:8000                  │  │
│   └─────────────────────────────────────────────────────┘  │
│                              │                              │
│              ┌───────────────┼───────────────┐              │
│              │               │               │              │
│              ▼               ▼               ▼              │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│   │ vLLM Pod 1  │ │ vLLM Pod 2  │ │ vLLM Pod 3  │          │
│   │ Llama 3.1   │ │ Llama 3.1   │ │ Mistral 7B  │          │
│   │   70B       │ │   70B       │ │             │          │
│   │  [4x GPU]   │ │  [4x GPU]   │ │  [1x GPU]   │          │
│   └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
│   설정:                                                     │
│   --gpu-memory-utilization 0.95                            │
│   --max-model-len 32768                                    │
│   --enable-prefix-caching                                  │
│   --api-key ${VLLM_API_KEY}                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### TEI/Infinity 임베딩 & 리랭킹 서버

```
┌─────────────────────────────────────────────────────────────┐
│              Embedding & Reranking Infrastructure           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────────────────────────────────────────────┐ │
│   │                TEI Embedding Server                   │ │
│   │                                                       │ │
│   │   Endpoint: http://tei-embedding:80/embed             │ │
│   │   Model: BAAI/bge-m3 (다국어 지원)                     │ │
│   │                                                       │ │
│   │   POST /embed                                         │ │
│   │   {                                                   │ │
│   │     "inputs": ["텍스트1", "텍스트2"]                   │ │
│   │   }                                                   │ │
│   │   → [[0.1, 0.2, ...], [0.3, 0.4, ...]]               │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
│   ┌──────────────────────────────────────────────────────┐ │
│   │                TEI Reranking Server                   │ │
│   │                                                       │ │
│   │   Endpoint: http://tei-reranker:80/rerank             │ │
│   │   Model: BAAI/bge-reranker-v2-m3                      │ │
│   │                                                       │ │
│   │   POST /rerank                                        │ │
│   │   {                                                   │ │
│   │     "query": "검색 질의",                              │ │
│   │     "texts": ["후보1", "후보2", "후보3"]               │ │
│   │   }                                                   │ │
│   │   → [{"index": 1, "score": 0.95}, ...]               │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 모델 배치 전략

| 모델 | GPU 요구량 | 용도 | 서빙 도구 |
|------|-----------|------|----------|
| Llama 3.1 70B | 4x A100 80GB | 복잡한 추론 | vLLM |
| Mistral 7B | 1x A100 40GB | 빠른 응답 | vLLM |
| Qwen 72B | 4x A100 80GB | 한국어 특화 | vLLM |
| bge-m3 | CPU/1x GPU | 임베딩 | TEI/Infinity |
| bge-reranker-v2-m3 | CPU/1x GPU | 리랭킹 | TEI/Infinity |

### 2.7 LLMOps 레이어

#### LLaMA-Factory 파인튜닝 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│               LLaMA-Factory Fine-tuning Pipeline            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [1] 데이터 준비                                            │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │ 데이터 수집 │ → │ 전처리/검증 │ → │ Alpaca 포맷 │      │
│   │  (CSV/JSON) │   │             │   │   변환      │      │
│   └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                             │
│   [2] LLaMA-Factory WebUI                                   │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│   │  │ 모델 선택   │  │  학습 설정  │  │  데이터셋   │  │  │
│   │  │ - Llama    │  │  - LoRA     │  │  선택       │  │  │
│   │  │ - Qwen     │  │  - QLoRA    │  │             │  │  │
│   │  │ - Mistral  │  │  - Full     │  │             │  │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│   │                                                       │  │
│   │  내장: DeepSpeed ZeRO-2/3, Gradient Checkpointing    │  │
│   └─────────────────────────────────────────────────────┘  │
│                              │                              │
│                     MLflow Tracking                         │
│                                                             │
│   [3] 모델 평가 & 내보내기                                   │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │ 벤치마크    │ → │ LoRA 병합   │ → │ vLLM 배포   │      │
│   │   평가      │   │ (선택적)    │   │             │      │
│   └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.8 인프라 레이어

#### Kubernetes 네임스페이스 구조

```yaml
# 네임스페이스 구조
namespaces:
  - name: llmflow-system      # 시스템 컴포넌트
    components:
      - dify
      - apisix
      - keycloak

  - name: llmflow-data        # 데이터 레이어
    components:
      - milvus
      - neo4j
      - postgresql
      - redis
      - minio

  - name: llmflow-inference   # 추론 레이어
    components:
      - vllm-deployments
      - tei-embedding
      - tei-reranker

  - name: llmflow-etl         # ETL 레이어
    components:
      - unstructured
      - llamaindex-workers

  - name: llmflow-mlops       # MLOps
    components:
      - mlflow
      - llama-factory

  - name: dept-finance        # 부서별 테넌트
  - name: dept-hr
  - name: project-ai
```

#### 리소스 할당 정책

```yaml
# ResourceQuota 예시 (부서별)
apiVersion: v1
kind: ResourceQuota
metadata:
  name: dept-finance-quota
  namespace: dept-finance
spec:
  hard:
    requests.cpu: "100"
    requests.memory: "200Gi"
    requests.nvidia.com/gpu: "8"
    limits.cpu: "200"
    limits.memory: "400Gi"
    limits.nvidia.com/gpu: "16"
    persistentvolumeclaims: "50"
    services: "20"
```

---

## 3. 네트워크 아키텍처

### 3.1 네트워크 토폴로지

```
┌─────────────────────────────────────────────────────────────┐
│                    사내 네트워크                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │              DMZ (비무장지대)                         │  │
│   │   ┌─────────────┐   ┌─────────────┐                 │  │
│   │   │   L4/L7     │   │   WAF       │                 │  │
│   │   │ 로드밸런서  │   │ 방화벽      │                 │  │
│   │   └─────────────┘   └─────────────┘                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                              │                              │
│                              ▼                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │            Application Network (10.0.0.0/16)        │  │
│   │                                                     │  │
│   │   ┌─────────────────────────────────────────────┐  │  │
│   │   │         Kubernetes Pod Network              │  │  │
│   │   │            (10.244.0.0/16)                  │  │  │
│   │   │                                             │  │  │
│   │   │  [NetworkPolicy로 네임스페이스 간 격리]       │  │  │
│   │   │                                             │  │  │
│   │   └─────────────────────────────────────────────┘  │  │
│   │                                                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                              │                              │
│                              ▼                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │            Storage Network (10.1.0.0/16)            │  │
│   │   ┌─────────────┐   ┌─────────────┐                 │  │
│   │   │  NFS/Ceph   │   │   MinIO     │                 │  │
│   │   └─────────────┘   └─────────────┘                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                              │                              │
│                              ▼                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │           GPU Network (100GbE/InfiniBand)           │  │
│   │   ┌─────────────┐   ┌─────────────┐                 │  │
│   │   │ GPU Node 1  │ ↔ │ GPU Node 2  │  (NCCL/RDMA)   │  │
│   │   └─────────────┘   └─────────────┘                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 NetworkPolicy 설정

```yaml
# 부서 간 네트워크 격리
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dept-finance-isolation
  namespace: dept-finance
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: dept-finance
        - namespaceSelector:
            matchLabels:
              name: llmflow-system  # 시스템 서비스 허용
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: dept-finance
        - namespaceSelector:
            matchLabels:
              name: llmflow-data    # 데이터 레이어 접근 허용
        - namespaceSelector:
            matchLabels:
              name: llmflow-inference  # 추론 서비스 접근 허용
```

---

## 4. 고가용성 (HA) 설계

### 4.1 HA 구성 매트릭스

| 컴포넌트 | HA 방식 | 최소 레플리카 | RTO | RPO |
|----------|--------|--------------|-----|-----|
| APISIX | Active-Active | 3 | 30초 | 0 |
| Keycloak | Active-Standby | 2 | 60초 | 0 |
| Dify API | Active-Active | 3 | 30초 | 0 |
| PostgreSQL | Primary-Standby (Patroni) | 3 | 60초 | 0 |
| Milvus | Distributed | 3+ | 30초 | 0 |
| Neo4j | Causal Cluster | 3 | 60초 | 0 |
| Redis | Sentinel | 3 | 30초 | 0 |
| vLLM | Multi-replica | 2+ | 30초 | N/A |
| TEI/Infinity | Multi-replica | 2+ | 30초 | N/A |

### 4.2 장애 복구 시나리오

```
┌─────────────────────────────────────────────────────────────┐
│                    장애 복구 흐름                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [시나리오 1: vLLM 인스턴스 장애]                           │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │ 헬스체크    │ → │ Pod 제외    │ → │ 트래픽      │      │
│   │ 실패 감지  │   │ (Endpoint)  │   │ 재분배      │      │
│   └─────────────┘   └─────────────┘   └─────────────┘      │
│                              │                              │
│                              ▼                              │
│                     K8s Deployment                          │
│                     새 Pod 자동 생성                         │
│                                                             │
│   [시나리오 2: 데이터베이스 장애]                             │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │ Primary     │ → │ Patroni     │ → │ Standby     │      │
│   │ 장애 감지  │   │ Failover    │   │ 승격        │      │
│   └─────────────┘   └─────────────┘   └─────────────┘      │
│                              │                              │
│                              ▼                              │
│                     클라이언트 재연결                        │
│                     (Connection Pool 갱신)                  │
│                                                             │
│   [시나리오 3: 전체 노드 장애]                               │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │ 노드 장애   │ → │ K8s 감지   │ → │ Pod 재스케줄│      │
│   │ 감지        │   │ (NotReady) │   │ (다른 노드) │      │
│   └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 확장성 설계

### 5.1 수평 확장 전략

| 컴포넌트 | 확장 트리거 | 확장 방식 | 최대 규모 |
|----------|------------|----------|----------|
| APISIX | CPU > 70% | HPA | 10+ |
| Dify API | 요청 수 > 1000 RPS | HPA | 20+ |
| Milvus Proxy | 쿼리 지연 > 100ms | Manual | 10+ |
| vLLM | GPU 사용률 > 80% | HPA | GPU 수 제한 |
| TEI/Infinity | 요청 대기 > 100 | HPA | 10+ |
| Worker | 대기 작업 > 100 | HPA | 50+ |

### 5.2 HPA 설정 예시

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: dify-api-hpa
  namespace: llmflow-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: dify-api
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "100"
```

---

## 6. 모니터링 아키텍처

### 6.1 모니터링 스택

```
┌─────────────────────────────────────────────────────────────┐
│                    Monitoring Stack                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                    Grafana                          │  │
│   │   ┌─────────┐  ┌─────────┐  ┌─────────┐            │  │
│   │   │ 인프라  │  │  LLM    │  │  비즈니스│            │  │
│   │   │ 대시보드│  │ 대시보드│  │ 대시보드 │            │  │
│   │   └─────────┘  └─────────┘  └─────────┘            │  │
│   └─────────────────────────────────────────────────────┘  │
│                              ▲                              │
│              ┌───────────────┼───────────────┐              │
│              │               │               │              │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│   │ Prometheus  │ │  Langfuse   │ │ OpenSearch  │          │
│   │ (메트릭)    │ │ (LLM 트레이싱)│ │ (로그)     │          │
│   └─────────────┘ └─────────────┘ └─────────────┘          │
│          ▲               ▲               ▲                  │
│          │               │               │                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │              Application Metrics/Logs               │  │
│   │  [APISIX] [Dify] [vLLM] [TEI] [Milvus] [Neo4j]     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 핵심 모니터링 지표

| 카테고리 | 지표 | 임계값 | 알림 |
|----------|------|--------|------|
| 추론 | LLM 응답 지연 시간 | > 5초 | Warning |
| 추론 | LLM 처리량 (TPS) | < 10 | Critical |
| 임베딩 | 임베딩 응답 시간 | > 500ms | Warning |
| 리랭킹 | 리랭킹 응답 시간 | > 200ms | Warning |
| GPU | GPU 사용률 | > 90% | Warning |
| GPU | GPU 메모리 | > 95% | Critical |
| 시스템 | API 에러율 | > 1% | Warning |
| 시스템 | API 가용성 | < 99.9% | Critical |
| 데이터 | Milvus 쿼리 지연 | > 500ms | Warning |
| 데이터 | Neo4j 쿼리 지연 | > 1초 | Warning |
| 데이터 | 벡터 인덱스 크기 | > 90% | Warning |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2025-12-13 | 초기 작성 | LLMFlow Team |
| 2.0 | 2025-12-13 | 오픈소스 조합 가이드 v2.0 반영 - Ray 제거, TEI/Infinity 추가, Unstructured 추가, Neo4j 추가, LLaMA-Factory 변경 | LLMFlow Team |
