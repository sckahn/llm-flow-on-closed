# ============================================
# LLMFlow Docker Compose - Full Stack
# Version: 2.0
# Services: 17 (Dify, vLLM, TEI, Milvus, Neo4j, etc.)
# ============================================

x-common-env: &common-env
  TZ: ${TZ:-Asia/Seoul}

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

services:
  # ============================================
  # Phase 1: Infrastructure Services
  # ============================================

  etcd:
    image: quay.io/coreos/etcd:v3.5.11
    container_name: llmflow-etcd
    restart: unless-stopped
    environment:
      <<: *common-env
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    command:
      - etcd
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd:2380
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-cluster=default=http://etcd:2380
      - --name=default
    volumes:
      - etcd-data:/etcd-data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "etcdctl", "endpoint", "health"]
    networks:
      - llmflow-data

  postgresql:
    image: postgres:16-alpine
    container_name: llmflow-postgresql
    restart: unless-stopped
    environment:
      <<: *common-env
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
    ports:
      - "5432:5432"
    networks:
      - llmflow-data

  redis:
    image: redis:7-alpine
    container_name: llmflow-redis
    restart: unless-stopped
    environment:
      <<: *common-env
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
    ports:
      - "6379:6379"
    networks:
      - llmflow-data

  minio:
    image: minio/minio:latest
    container_name: llmflow-minio
    restart: unless-stopped
    environment:
      <<: *common-env
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - llmflow-data

  # ============================================
  # Phase 2: Data Stores
  # ============================================

  milvus-standalone:
    image: milvusdb/milvus:v2.4.0
    container_name: llmflow-milvus
    restart: unless-stopped
    environment:
      <<: *common-env
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      MINIO_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
    command: ["milvus", "run", "standalone"]
    volumes:
      - milvus-data:/var/lib/milvus
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      start_period: 120s
    ports:
      - "19530:19530"
      - "9091:9091"
    networks:
      - llmflow-data

  neo4j:
    image: neo4j:5.15.0-enterprise
    container_name: llmflow-neo4j
    restart: unless-stopped
    environment:
      <<: *common-env
      NEO4J_AUTH: ${NEO4J_AUTH}
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_memory_heap_initial__size: "1G"
      NEO4J_dbms_memory_heap_max__size: "2G"
      NEO4J_dbms_memory_pagecache_size: "1G"
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*,gds.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*,gds.*"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-plugins:/plugins
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      start_period: 60s
    ports:
      - "7474:7474"
      - "7687:7687"
    networks:
      - llmflow-data

  # ============================================
  # Phase 3: Auth & Gateway
  # ============================================

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: llmflow-keycloak
    restart: unless-stopped
    environment:
      <<: *common-env
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgresql:5432/keycloak
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
      KC_HTTP_ENABLED: "true"
    command: start-dev
    depends_on:
      postgresql:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      start_period: 60s
    ports:
      - "8080:8080"
    networks:
      - llmflow-auth
      - llmflow-data

  apisix:
    image: apache/apisix:3.8.0-debian
    container_name: llmflow-apisix
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - ./configs/apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
      - ./configs/apisix/apisix.yaml:/usr/local/apisix/conf/apisix.yaml:ro
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:9080/apisix/status"]
      interval: 10s
    ports:
      - "9080:9080"
      - "9443:9443"
      - "9180:9180"
    networks:
      - llmflow-frontend
      - llmflow-backend
      - llmflow-auth
      - llmflow-data

  # ============================================
  # Phase 4: Core Platform (Dify)
  # ============================================

  dify-api:
    image: langgenius/dify-api:0.11.0
    container_name: llmflow-dify-api
    restart: unless-stopped
    environment:
      <<: *common-env
      MODE: api
      LOG_LEVEL: INFO
      SECRET_KEY: ${DIFY_SECRET_KEY}
      INIT_PASSWORD: ${DIFY_INIT_PASSWORD}
      CONSOLE_WEB_URL: http://localhost:3030
      SERVICE_API_URL: http://localhost:5001
      APP_WEB_URL: http://localhost:3030
      CONSOLE_CORS_ALLOW_ORIGINS: http://localhost:3030,http://127.0.0.1:3030,*
      WEB_API_CORS_ALLOW_ORIGINS: http://localhost:3030,http://127.0.0.1:3030,*
      # Database
      DB_HOST: postgresql
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_DATABASE: dify
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      # Storage
      STORAGE_TYPE: s3
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET_NAME: dify
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      S3_REGION: us-east-1
      S3_USE_SSL: "false"
      # Vector Store
      VECTOR_STORE: milvus
      MILVUS_HOST: milvus-standalone
      MILVUS_PORT: 19530
      # Observability
      LANGFUSE_PUBLIC_KEY: ""
      LANGFUSE_SECRET_KEY: ""
      LANGFUSE_HOST: http://langfuse:3000
    volumes:
      - dify-storage:/app/api/storage
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus-standalone:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
    ports:
      - "5001:5001"
    networks:
      - llmflow-backend
      - llmflow-data
      - llmflow-inference

  dify-worker:
    image: langgenius/dify-api:0.11.0
    container_name: llmflow-dify-worker
    restart: unless-stopped
    environment:
      <<: *common-env
      MODE: worker
      LOG_LEVEL: INFO
      SECRET_KEY: ${DIFY_SECRET_KEY}
      # Database
      DB_HOST: postgresql
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_DATABASE: dify
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      # Storage
      STORAGE_TYPE: s3
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET_NAME: dify
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      S3_REGION: us-east-1
      S3_USE_SSL: "false"
      # Vector Store
      VECTOR_STORE: milvus
      MILVUS_HOST: milvus-standalone
      MILVUS_PORT: 19530
    volumes:
      - dify-storage:/app/api/storage
    depends_on:
      - dify-api
    networks:
      - llmflow-backend
      - llmflow-data
      - llmflow-inference

  # Original Dify Web - Disabled in favor of llmflow-ui
  # dify-web:
  #   image: langgenius/dify-web:0.11.0
  #   container_name: llmflow-dify-web
  #   ...

  # LLMFlow UI - Custom frontend (replaces dify-web)
  llmflow-ui:
    build:
      context: ../ui
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:5001
        NEXT_PUBLIC_APP_NAME: LLMFlow
    container_name: llmflow-ui
    restart: unless-stopped
    environment:
      <<: *common-env
      NEXT_PUBLIC_API_URL: http://localhost:5001
      NEXT_PUBLIC_APP_NAME: LLMFlow
    depends_on:
      - dify-api
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
    ports:
      - "3030:3000"
    networks:
      - llmflow-frontend
      - llmflow-backend

  # ============================================
  # Phase 5: Inference Services
  # ============================================

  vllm:
    image: vllm/vllm-openai:latest
    container_name: llmflow-vllm
    restart: unless-stopped
    environment:
      <<: *common-env
      VLLM_API_KEY: ${VLLM_API_KEY}
      HF_HOME: /models
      # Llama 4 MoE requires NCCL for multi-GPU
      NCCL_P2P_DISABLE: "0"
      NCCL_IB_DISABLE: "0"
    command:
      - --model
      - ${VLLM_MODEL_PATH:-/models/llama-4-mini}
      - --api-key
      - ${VLLM_API_KEY}
      - --host
      - "0.0.0.0"
      - --port
      - "8000"
      - --gpu-memory-utilization
      - "${VLLM_GPU_MEMORY_UTILIZATION:-0.9}"
      - --max-model-len
      - "${VLLM_MAX_MODEL_LEN:-32768}"
      - --tensor-parallel-size
      - "${VLLM_TENSOR_PARALLEL:-1}"
      - --enable-prefix-caching
      - --trust-remote-code
      # FP8 for H200 optimization (Prod only)
      # - --quantization
      # - fp8
    volumes:
      - ../models:/models:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${VLLM_GPU_COUNT:-1}
              capabilities: [gpu]
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      start_period: 180s
    ports:
      - "8000:8000"
    networks:
      - llmflow-inference

  tei-embedding:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    container_name: llmflow-tei-embedding
    restart: unless-stopped
    environment:
      <<: *common-env
    command:
      - --model-id
      - ${TEI_EMBEDDING_MODEL:-BAAI/bge-m3}
      - --port
      - "80"
      - --max-client-batch-size
      - "32"
      - --max-batch-tokens
      - "16384"
    volumes:
      - tei-models:/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      start_period: 120s
    ports:
      - "8080:80"
    networks:
      - llmflow-inference

  tei-reranker:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    container_name: llmflow-tei-reranker
    restart: unless-stopped
    environment:
      <<: *common-env
    command:
      - --model-id
      - ${TEI_RERANKER_MODEL:-BAAI/bge-reranker-v2-m3}
      - --port
      - "80"
      - --max-client-batch-size
      - "32"
    volumes:
      - tei-models:/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      start_period: 120s
    ports:
      - "8081:80"
    networks:
      - llmflow-inference

  unstructured:
    image: quay.io/unstructured-io/unstructured-api:0.0.80
    container_name: llmflow-unstructured
    restart: unless-stopped
    environment:
      <<: *common-env
      UNSTRUCTURED_PARALLEL_MODE_ENABLED: "true"
      UNSTRUCTURED_PARALLEL_MODE_THREADS: "4"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthcheck"]
    ports:
      - "8001:8000"
    networks:
      - llmflow-inference

  # ============================================
  # Phase 5.5: GraphRAG Service
  # ============================================

  graphrag:
    build:
      context: ../services/graphrag
      dockerfile: Dockerfile
    container_name: llmflow-graphrag
    restart: unless-stopped
    environment:
      <<: *common-env
      # Neo4j connection
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      # Milvus connection
      MILVUS_HOST: milvus-standalone
      MILVUS_PORT: 19530
      # LLM (vLLM) - OpenAI compatible API
      LLM_API_BASE: http://vllm:8000/v1
      LLM_API_KEY: ${VLLM_API_KEY}
      LLM_MODEL: ${VLLM_MODEL_NAME:-Meta-Llama-3.1-8B-Instruct}
      # Embedding (TEI)
      EMBEDDING_API_BASE: http://tei-embedding:80
      # Search parameters
      VECTOR_TOP_K: 20
      GRAPH_MAX_DEPTH: 3
      RRF_K: 60
    depends_on:
      neo4j:
        condition: service_healthy
      milvus-standalone:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    ports:
      - "8082:8080"
    networks:
      - llmflow-backend
      - llmflow-data
      - llmflow-inference

  # ============================================
  # Phase 6: LLMOps & Observability
  # ============================================

  llama-factory:
    image: hiyouga/llama-factory:latest
    container_name: llmflow-llama-factory
    restart: unless-stopped
    environment:
      <<: *common-env
      GRADIO_SERVER_NAME: ${LLAMA_FACTORY_GRADIO_SERVER_NAME:-0.0.0.0}
      GRADIO_SERVER_PORT: ${LLAMA_FACTORY_GRADIO_SERVER_PORT:-7860}
    command: llamafactory-cli webui
    volumes:
      - ../models:/app/models
      - llama-factory-data:/app/data
      - llama-factory-output:/app/output
      - llama-factory-cache:/root/.cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    ports:
      - "7860:7860"
    networks:
      - llmflow-backend
      - llmflow-data

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.10.0
    container_name: llmflow-mlflow
    restart: unless-stopped
    environment:
      <<: *common-env
      MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/mlflow
      MLFLOW_DEFAULT_ARTIFACT_ROOT: s3://mlflow-artifacts
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    command: mlflow server --host 0.0.0.0 --port 5000
    depends_on:
      postgresql:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
    ports:
      - "5000:5000"
    networks:
      - llmflow-monitoring
      - llmflow-data

  langfuse:
    image: langfuse/langfuse:2
    container_name: llmflow-langfuse
    restart: unless-stopped
    environment:
      <<: *common-env
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/langfuse
      NEXTAUTH_URL: http://localhost:3001
      NEXTAUTH_SECRET: ${LANGFUSE_NEXT_AUTH_SECRET}
      SALT: ${LANGFUSE_SALT}
      LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: "true"
    depends_on:
      postgresql:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/public/health"]
    ports:
      - "3001:3000"
    networks:
      - llmflow-monitoring
      - llmflow-data
      - llmflow-backend

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: llmflow-prometheus
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_TIME:-15d}'
      - '--web.enable-lifecycle'
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:9090/-/healthy"]
    ports:
      - "9090:9090"
    networks:
      - llmflow-monitoring

  grafana:
    image: grafana/grafana:10.2.3
    container_name: llmflow-grafana
    restart: unless-stopped
    environment:
      <<: *common-env
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./configs/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
      - prometheus
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
    ports:
      - "3032:3000"
    networks:
      - llmflow-monitoring

# ============================================
# Networks
# ============================================

networks:
  llmflow-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.1.0/24

  llmflow-backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.2.0/24

  llmflow-data:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.3.0/24

  llmflow-inference:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.4.0/24

  llmflow-auth:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.5.0/24

  llmflow-monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.6.0/24

# ============================================
# Volumes
# ============================================

volumes:
  etcd-data:
  postgresql-data:
  redis-data:
  minio-data:
  milvus-data:
  neo4j-data:
  neo4j-logs:
  neo4j-plugins:
  dify-storage:
  tei-models:
  llama-factory-data:
  llama-factory-output:
  llama-factory-cache:
  prometheus-data:
  grafana-data:
